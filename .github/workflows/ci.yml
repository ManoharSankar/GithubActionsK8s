name: Kubernetes CI with kind

on:
  push:
    branches: [ "main" ]

jobs:
  kind-ci:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1️⃣ Create kind cluster
      - name: Create kind cluster
        uses: helm/kind-action@v1.10.0
        with:
          cluster_name: kind
          wait: 120s

      # 2️⃣ Verify cluster
      - name: Verify cluster
        run: kubectl get nodes

      # 3️⃣ Build Docker image
      - name: Build Docker image
        run: docker build -t python-microservice:ci -f docker/Dockerfile .

      # 4️⃣ Load image into kind
      - name: Load image into kind
        run: kind load docker-image python-microservice:ci

      # 5️⃣ Deploy manifests
      - name: Deploy to Kubernetes
        run: kubectl apply -f k8s/

      # 6️⃣ Wait for rollout
      - name: Wait for deployment
        run: kubectl rollout status deployment/python-microservice

      # 7️⃣ Smoke test
      - name: Smoke test
        run: |
          kubectl port-forward svc/python-microservice 8080:80 &
          sleep 10
          curl -f http://localhost:8080/health
